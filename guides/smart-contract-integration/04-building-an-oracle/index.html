<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Manekiswap - Knowledge base RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Manekiswap - Knowledge base Atom Feed"><title data-react-helmet="true">Building an Oracle | Manekiswap - Knowledge base</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://info.manekiswap.com/guides/smart-contract-integration/04-building-an-oracle"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Building an Oracle | Manekiswap - Knowledge base"><meta data-react-helmet="true" name="description" content="To build a price oracle on Uniswap V2, you must first understand the"><meta data-react-helmet="true" property="og:description" content="To build a price oracle on Uniswap V2, you must first understand the"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://info.manekiswap.com/guides/smart-contract-integration/04-building-an-oracle"><link data-react-helmet="true" rel="alternate" href="https://info.manekiswap.com/guides/smart-contract-integration/04-building-an-oracle" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://info.manekiswap.com/guides/smart-contract-integration/04-building-an-oracle" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c9a9c9c8.css">
<link rel="preload" href="/assets/js/runtime~main.81c62476.js" as="script">
<link rel="preload" href="/assets/js/main.70979045.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Manekiswap Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.png" alt="Manekiswap Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Manekiswap</b></a><a class="navbar__item navbar__link navbar__link--active" href="/">Document</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/manekiswap/manekiswap.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Guides</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Interface Integration</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Javascript SDK</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Smart Contract Integration</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/01-quick-start">Smart Contract Quick start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/02-trading-from-a-smart-contract">Implement a Swap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/03-providing-liquidity">Providing Liquidity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/guides/smart-contract-integration/04-building-an-oracle">Building an Oracle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/05-using-flash-swaps">Flash Swaps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/06-getting-pair-addresses">Pair Addresses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/07-supporting-meta-transactions">Supporting meta transactions</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Technical Reference</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Building an Oracle</h1></header><p>To build a price oracle on Uniswap V2, you must first understand the
requirements for your use case. Once you understand the kind of price
average you require, it is a matter of storing the cumulative price
variable from the pair as often as necessary, and computing
the average price using two or more observations of the
cumulative price variables.</p><header><h1>Understanding requirements</h1></header><p>To understand your requirements, you should first research the answer to the
following questions:</p><ul><li>Is data freshness important?
I.e.: must the price average include the current price?</li><li>Are recent prices more important than historical prices?
I.e.: is the current price given more weight than historical prices?</li></ul><p>Note your answers for the following discussion.</p><header><h1>Oracle Strategies</h1></header><h2 class="anchor anchorWithStickyNavbar_y2LR" id="fixed-windows">Fixed windows<a aria-hidden="true" class="hash-link" href="#fixed-windows" title="Direct link to heading">â€‹</a></h2><p>In the case where data freshness is not important and recent prices
are weighted equally with historical prices, it is enough to
store the cumulative price once per period (e.g. once per 24 hours.)</p><p>Computing the average price over these data points gives you &#x27;fixed windows&#x27;,
which can be updated after the lapse of each period. We wrote
an example oracle of this kind
<a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleOracleSimple.sol" target="_blank" rel="noopener noreferrer">here</a>.</p><div href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleOracleSimple.sol">ExampleOracleSimple.sol</div><p>This example does not limit the maximum size of the fixed window, i.e.
it only requires that the window size is greater than 1 period (e.g. 24 hours).</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="moving-averages">Moving averages<a aria-hidden="true" class="hash-link" href="#moving-averages" title="Direct link to heading">â€‹</a></h2><p>In the case where data freshness is important, you can use a sliding
window in which the cumulative price variable is measured more often
than once per period.</p><p>There are at least
<a href="https://www.investopedia.com/terms/m/movingaverage.asp#types-of-moving-averages" target="_blank" rel="noopener noreferrer">two kinds of moving averages</a>
that you can compute using the Uniswap cumulative price variable.</p><p><a href="https://www.investopedia.com/terms/s/sma.asp" target="_blank" rel="noopener noreferrer">Simple moving averages</a>
give equal weight to each price measurement. We have built
an example of a sliding window oracle
<a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleSlidingWindowOracle.sol" target="_blank" rel="noopener noreferrer">here</a>.</p><p><a href="https://www.investopedia.com/terms/e/ema.asp" target="_blank" rel="noopener noreferrer">Exponential moving averages</a>
give more weight to the most recent price measurements. We do not yet have an example written for this type of oracle.</p><p>You may wish to use exponential moving averages where recent prices
are more important than historical prices, e.g. in case of liquidations. However, note that
putting more weight on recent prices makes the oracle cheaper to manipulate
than weighting all price measurements equally.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="computing-average-prices">Computing average prices<a aria-hidden="true" class="hash-link" href="#computing-average-prices" title="Direct link to heading">â€‹</a></h2><p>To compute the average price given two cumulative price observations, take the difference between
the cumulative price at the beginning and end of the period, and
divide by the elapsed time between them in seconds. This will produce a
<a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic#Notation" target="_blank" rel="noopener noreferrer">fixed point unsigned Q112x112</a>
number that represents the price of one asset relative to the other. This number is represented as a <code>uint224</code> where
the upper 112 bits represent the integer amount, and the lower 112 bits represent the fractional amount.</p><p>Pairs contain both <code>price0CumulativeLast</code> and <code>price1CumulativeLast</code>, which are ratios of reserves
of <code>token1</code>/<code>token0</code> and <code>token0</code>/<code>token1</code> respectively. I.e. the price of <code>token0</code> is expressed in terms of
<code>token1</code>/<code>token0</code>, while the price of <code>token1</code> is expressed in terms of <code>token0</code>/<code>token1</code>.</p><header><h1>Getting the latest cumulative price</h1></header><p>If you wish to compute the average price between a historical price cumulative observation and the current cumulative
price, you should use the cumulative price values from the current block. If the cumulative price has not been updated
in the current block, e.g. because there has not been any liquidity event (<code>mint</code>/<code>burn</code>/<code>swap</code>) on the pair in the current
block, you can compute the cumulative price counterfactually.</p><p>We provide a library for use in oracle contracts that has the method
<a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/libraries/UniswapV2OracleLibrary.sol#L16" target="_blank" rel="noopener noreferrer"><code>UniswapV2OracleLibrary#currentCumulativePrices</code></a>
for getting the cumulative price as of the current block.
The current cumulative price returned by this method is computed <em>counterfactually</em>, meaning it requires no call to
the relative gas-expensive <code>#sync</code> method on the pair.
It is correct regardless of whether a swap has already executed in the current block.</p><header><h1>Notes on overflow</h1></header><p>The <code>UniswapV2Pair</code> cumulative price variables are designed to eventually overflow,
i.e. <code>price0CumulativeLast</code> and <code>price1CumulativeLast</code> and <code>blockTimestampLast</code> will overflow through 0.</p><p>This should not pose an issue to your oracle design, as the price average computation is concerned with differences
(i.e. subtraction) between two separate observations of a cumulative price variable.
Subtracting between two cumulative price values will result in a number that fits within the range of <code>uint256</code> as long
as the observations are made for periods of max <code>2^32</code> seconds, or ~136 years.</p><p><code>blockTimestampLast</code> is stored only in a <code>uint32</code>. For the same reason as described above, the pair can save a
storage slot, and many SSTORES over the life of the pair, by storing only <code>block.timestamp % uint32(-1)</code>.
This is feasible because the pair is only concerned with the time that elapses between each liquidity event when updating
the cumulative prices, which is always expected to be less than <code>2^32</code> seconds.</p><p>When computing time elapsed within your own oracle, you can simply store the <code>block.timestamp</code> of your observations
as <code>uint256</code>, and avoid dealing with overflow math for computing the time elapsed between observations. This is how the
<a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleSlidingWindowOracle.sol" target="_blank" rel="noopener noreferrer">ExampleSlidingWindowOracle</a>
handles observation timestamps.</p><div href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleSlidingWindowOracle.sol">ExampleSlidingWindowOracle</div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="integrating-the-oracle">Integrating the oracle<a aria-hidden="true" class="hash-link" href="#integrating-the-oracle" title="Direct link to heading">â€‹</a></h2><p>To integrate an oracle into your contracts, you must ensure the oracle&#x27;s observations of the cumulative price variable
are kept up to date.
As long as your oracle is up to date, you can depend on it to produce average prices.
The process of keeping your oracle up to date is called &#x27;maintenance&#x27;.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="oracle-maintenance">Oracle maintenance<a aria-hidden="true" class="hash-link" href="#oracle-maintenance" title="Direct link to heading">â€‹</a></h2><p>In order to measure average prices over a period, the oracle must have a way
of referencing the cumulative price at the start and end of a period.
The recommended way of doing this is by storing these prices in the oracle contract,
and calling the oracle frequently enough to store the latest cumulative price.</p><p>Reliable oracle maintenance is a difficult task,
and can become a point of failure in times of congestion.
Instead, consider building this functionality directly into the
critical calls of your own smart contracts, or incentivize oracle
maintenance calls by other parties.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="no-maintenance-option">No-maintenance option<a aria-hidden="true" class="hash-link" href="#no-maintenance-option" title="Direct link to heading">â€‹</a></h2><p>It is possible to avoid regularly storing this cumulative price at the
start of the period by utilizing storage proofs. However, this approach has limitations,
especially in regard to gas cost and maximum length of the time period over which the average price can be measured.
If you wish to try this approach, you can follow
<a href="https://github.com/Keydonix/uniswap-oracle/" target="_blank" rel="noopener noreferrer">this repository by Keydonix</a>.</p><div href="https://github.com/Keydonix/uniswap-oracle">Keydonix: on-chain trustless and censorship resistant oracle</div><p>Keydonix has developed a general purpose price feed oracle built on Uniswap v2 that supports arbitrary time windows (up to 256 blocks) and doesn&#x27;t require any active maintenance.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/oracles">oracles</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/documentation">documentation</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/manekiswap/manekiswap.github.io/edit/master/docs/guides/smart-contract-integration/04-building-an-oracle.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/guides/smart-contract-integration/03-providing-liquidity"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Providing Liquidity</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/guides/smart-contract-integration/05-using-flash-swaps"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Flash Swaps<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#fixed-windows" class="table-of-contents__link toc-highlight">Fixed windows</a></li><li><a href="#moving-averages" class="table-of-contents__link toc-highlight">Moving averages</a></li><li><a href="#computing-average-prices" class="table-of-contents__link toc-highlight">Computing average prices</a></li><li><a href="#integrating-the-oracle" class="table-of-contents__link toc-highlight">Integrating the oracle</a></li><li><a href="#oracle-maintenance" class="table-of-contents__link toc-highlight">Oracle maintenance</a></li><li><a href="#no-maintenance-option" class="table-of-contents__link toc-highlight">No-maintenance option</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://t.me/manekiswap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/manekiswap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/manekiswap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Manekiswap, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.81c62476.js"></script>
<script src="/assets/js/main.70979045.js"></script>
</body>
</html>