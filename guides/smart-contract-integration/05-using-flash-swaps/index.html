<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Manekiswap - Knowledge base RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Manekiswap - Knowledge base Atom Feed"><title data-react-helmet="true">Flash Swaps | Manekiswap - Knowledge base</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://info.manekiswap.com/guides/smart-contract-integration/05-using-flash-swaps"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Flash Swaps | Manekiswap - Knowledge base"><meta data-react-helmet="true" name="description" content="Flash swaps are an integral feature of Uniswap V2. In fact, under the hood, all swaps are actually flash swaps! This simply means that pair contracts send output tokens to the recipient before enforcing that enough input tokens have been received. This is slightly atypical, as one might expect a pair to ensure it&#x27;s received payment before delivery. However, because Ethereum transactions are atomic, we can roll back the entire swap if it turns out that the contract hasn&#x27;t received enough tokens to make itself whole by the end of the transaction."><meta data-react-helmet="true" property="og:description" content="Flash swaps are an integral feature of Uniswap V2. In fact, under the hood, all swaps are actually flash swaps! This simply means that pair contracts send output tokens to the recipient before enforcing that enough input tokens have been received. This is slightly atypical, as one might expect a pair to ensure it&#x27;s received payment before delivery. However, because Ethereum transactions are atomic, we can roll back the entire swap if it turns out that the contract hasn&#x27;t received enough tokens to make itself whole by the end of the transaction."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://info.manekiswap.com/guides/smart-contract-integration/05-using-flash-swaps"><link data-react-helmet="true" rel="alternate" href="https://info.manekiswap.com/guides/smart-contract-integration/05-using-flash-swaps" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://info.manekiswap.com/guides/smart-contract-integration/05-using-flash-swaps" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.c9a9c9c8.css">
<link rel="preload" href="/assets/js/runtime~main.81c62476.js" as="script">
<link rel="preload" href="/assets/js/main.70979045.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Manekiswap Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.png" alt="Manekiswap Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Manekiswap</b></a><a class="navbar__item navbar__link navbar__link--active" href="/">Document</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/manekiswap/manekiswap.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Guides</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Interface Integration</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Javascript SDK</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Smart Contract Integration</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/01-quick-start">Smart Contract Quick start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/02-trading-from-a-smart-contract">Implement a Swap</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/03-providing-liquidity">Providing Liquidity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/04-building-an-oracle">Building an Oracle</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/guides/smart-contract-integration/05-using-flash-swaps">Flash Swaps</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/06-getting-pair-addresses">Pair Addresses</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/guides/smart-contract-integration/07-supporting-meta-transactions">Supporting meta transactions</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Technical Reference</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Flash Swaps</h1></header><p>Flash swaps are an integral feature of Uniswap V2. In fact, under the hood, all swaps are actually flash swaps! This simply means that pair contracts send output tokens to the recipient <em>before</em> enforcing that enough input tokens have been received. This is slightly atypical, as one might expect a pair to ensure it&#x27;s received payment before delivery. However, because Ethereum transactions are <em>atomic</em>, we can roll back the entire swap if it turns out that the contract hasn&#x27;t received enough tokens to make itself whole by the end of the transaction.</p><p>To see how this all works, let&#x27;s start by examining the interface of the <code>swap</code> function:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI solidity"><pre tabindex="0" class="prism-code language-solidity codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">function swap(uint amount0Out, uint amount1Out, address to, bytes calldata data);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>For the sake of example, let&#x27;s assume that we&#x27;re dealing with a DAI/WETH pair, where DAI is <code>token0</code> and WETH is <code>token1</code>. <code>amount0Out</code> and <code>amount1Out</code> specify the amount of DAI and WETH that the <code>msg.sender</code> wants the pair to send to the <code>to</code> address (one of these amounts may be 0). At this point you may be wondering how the contract <em>receives</em> tokens. For a typical (non-flash) swap, it&#x27;s actually the responsibility of <code>msg.sender</code> to ensure that enough WETH or DAI has <em>already been sent</em> to the pair before <code>swap</code> is called (in the context of trading, this is all handled neatly by a router contract). But when executing a flash swap, <em>tokens do not need to be sent to the contract before calling <code>swap</code></em>. Instead, they must be sent from within a <em>callback function</em> that the pair triggers on the <code>to</code> address.</p><header><h1>Triggering a Flash Swap</h1></header><p>To differentiate between the &quot;typical&quot; trading case and the flash swap case, pairs use the <code>data</code> parameter. Specifically, if <code>data.length</code> equals 0, the contract assumes that payment has already been received, and simply transfers the tokens to the <code>to</code> address. But, if <code>data.length</code> is greater than 0, the contract transfers the tokens and then calls the following function on the <code>to</code> address:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI solidity"><pre tabindex="0" class="prism-code language-solidity codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data);</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The logic behind this identification strategy is simple: the vast majority of valid flash swap use cases involve interactions with external protocols. The best way to pass information dictating how these interactions happen (function arguments, safety parameters, addresses, etc.) is via the <code>data</code> parameter. It&#x27;s expected that <code>data</code> will be <code>abi.decode</code>d from within <code>uniswapV2Call</code>. In the rare case where no data is required, callers should ensure that <code>data.length</code> equals 1 (i.e. encode a single junk byte as <code>bytes</code>), and then ignore this argument in <code>uniswapV2Call</code>.</p><p>Pairs call <code>uniswapV2Call</code> with the <code>sender</code> argument set to the <code>msg.sender</code> of the <code>swap</code>. <code>amount0</code> and <code>amount1</code> are simply <code>amount0Out</code> and <code>amount1Out</code>.</p><header><h1>Using uniswapV2Call</h1></header><p>There are several conditions that should be checked in all <code>uniswapV2Call</code> functions:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI solidity"><pre tabindex="0" class="prism-code language-solidity codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address token0 = IUniswapV2Pair(msg.sender).token0(); // fetch the address of token0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  address token1 = IUniswapV2Pair(msg.sender).token1(); // fetch the address of token1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  assert(msg.sender == IUniswapV2Factory(factoryV2).getPair(token0, token1)); // ensure that msg.sender is a V2 pair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // rest of the function goes here!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The first 2 lines simply fetch the token addresses from the pair, and the 3rd ensures that the <code>msg.sender</code> is an actual Uniswap V2 pair address.</p><header><h1>Repayment</h1></header><p>At the end of <code>uniswapV2Call</code>, contracts must return enough tokens to the pair to make it whole. Specifically, this means that the product of the pair reserves after the swap, discounting all token amounts sent by 0.3% LP fee, must be greater than before.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="multi-token">Multi-Token<a aria-hidden="true" class="hash-link" href="#multi-token" title="Direct link to heading">â€‹</a></h2><p>In the case where the token withdrawn is <em>not</em> the token returned (i.e. DAI was requested in the flash swap, and WETH was returned, or vice versa), the fee simplifies to the simple swap case. This means that the standard <code>getAmountIn</code> pricing function should be used to calculate e.g., the amount of WETH that must be returned in exchange for the amount of DAI that was requested out.</p><p>This type of fee calculation gives a slight advantage to the caller, as the fee derived from repayment in a corresponding token will always be slightly less than the fee derived from a direct token repayment, as a result of the difference between the amount required to pay back a swap, versus the amount withdrawn and then directly returned. The approximate comparison of fees is ~ 30 bps for a swap fee vs. 30.09 bps for a direct repayment.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="single-token">Single-Token<a aria-hidden="true" class="hash-link" href="#single-token" title="Direct link to heading">â€‹</a></h2><p>In the case where the token withdrawn is the <em>same</em> as the token returned (i.e. DAI was requested in the flash swap, used, then returned, or vice versa with WETH), the following condition must be satisfied:</p><p><code>DAIReservePre - DAIWithdrawn + (DAIReturned * .997) &gt;= DAIReservePre</code></p><p>It may be more intuitive to rewrite this formula in terms of a &quot;fee&quot; levied on the <em>withdrawn</em> amount (despite the fact that Uniswap always levies fees on input amounts, in this case the <em>returned</em> amount, here we can simplify to an effective fee on the <em>withdrawn</em> amount). If we rearrange, the formula looks like:</p><p><code>(DAIReturned * .997) - DAIWithdrawn &gt;= 0</code></p><p><code>DAIReturned &gt;= DAIWithdrawn / .997</code></p><p>So, the effective fee on the withdrawn amount is <code>.003 / .997 â‰ˆ 0.3009027%</code>.</p><header><h1>Resources</h1></header><p>For further exploration of flash swaps, see the <a href="https://uniswap.org/whitepaper.pdf" target="_blank" rel="noopener noreferrer">whitepaper</a>.</p><header><h1>Example</h1></header><p>A fully functional example of flash swaps is available: <a href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleFlashSwap.sol" target="_blank" rel="noopener noreferrer"><code>ExampleFlashSwap.sol</code></a>.</p><div href="https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleSwapToPrice.sol">ExampleSwapToPrice.sol</div><header><h1>Interface</h1></header><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI solidity"><pre tabindex="0" class="prism-code language-solidity codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">import &#x27;@uniswap/v2-core/contracts/interfaces/IUniswapV2Callee.sol&#x27;;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI solidity"><pre tabindex="0" class="prism-code language-solidity codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">pragma solidity &gt;=0.5.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">interface IUniswapV2Callee {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  function uniswapV2Call(address sender, uint amount0, uint amount1, bytes calldata data) external;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/smart-contract-integration">smart contract integration</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/developer-guides">developer-guides</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/tags/documentation">documentation</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/manekiswap/manekiswap.github.io/edit/master/docs/guides/smart-contract-integration/05-using-flash-swaps.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/guides/smart-contract-integration/04-building-an-oracle"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Building an Oracle</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/guides/smart-contract-integration/06-getting-pair-addresses"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Pair Addresses<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#multi-token" class="table-of-contents__link toc-highlight">Multi-Token</a></li><li><a href="#single-token" class="table-of-contents__link toc-highlight">Single-Token</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Links</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://t.me/manekiswap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/manekiswap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/manekiswap" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Manekiswap, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.81c62476.js"></script>
<script src="/assets/js/main.70979045.js"></script>
</body>
</html>